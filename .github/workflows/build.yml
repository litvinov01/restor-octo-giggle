name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ created ]

jobs:
  build:
    name: Build ${{ matrix.os }} (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: windows-x86_64
            artifact_ext: .exe
            
          # Linux
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: linux-x86_64
            artifact_ext: ""
            
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: macos-x86_64
            artifact_ext: ""
            
          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: macos-aarch64
            artifact_ext: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust_samples/target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Build
        working-directory: rust_samples
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          strip rust_samples/target/${{ matrix.target }}/release/rust_samples${{ matrix.artifact_ext }}
        continue-on-error: true

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: restor-octo-giggle-${{ matrix.artifact_name }}
          path: rust_samples/target/${{ matrix.target }}/release/rust_samples${{ matrix.artifact_ext }}

  package:
    name: Package Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Create release packages
        run: |
          mkdir -p dist
          
          # Get version from tag
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          
          # Package each artifact
          for artifact in artifacts/*/; do
            name=$(basename "$artifact")
            binary="$artifact/rust_samples"
            if [ ! -f "$binary" ]; then
              binary="$artifact/rust_samples.exe"
            fi
            
            if [ -f "$binary" ]; then
              # Extract platform from artifact name
              platform=$(echo "$name" | sed 's/restor-octo-giggle-//')
              pkg_name="restor-octo-giggle-${VERSION}-${platform}"
              
              mkdir -p "dist/$pkg_name"
              cp "$binary" "dist/$pkg_name/restor-octo-giggle"
              if [[ "$platform" == *"windows"* ]]; then
                mv "dist/$pkg_name/restor-octo-giggle" "dist/$pkg_name/restor-octo-giggle.exe"
              fi
              cp rust_samples/README.md "dist/$pkg_name/" 2>/dev/null || true
              
              # Create archive
              if [[ "$platform" == *"windows"* ]]; then
                cd dist && zip -r "${pkg_name}.zip" "$pkg_name" && cd ..
              else
                cd dist && tar czf "${pkg_name}.tar.gz" "$pkg_name" && cd ..
              fi
            fi
          done

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run tests
        working-directory: rust_samples
        run: cargo test

      - name: Check formatting
        working-directory: rust_samples
        run: cargo fmt -- --check

      - name: Clippy
        working-directory: rust_samples
        run: cargo clippy -- -D warnings
